--[[
    Velour UI Library v3.0 (Fixed & Configurable)
    Features: Saved Configs, Platform Picker, Responsive, 100% Secure
]]

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local Camera = workspace.CurrentCamera

local Library = {}

--// Configuration System
local ConfigFile = "Vanta_Layout_Config.json"

local function SavePlatform(mode)
    if writefile then
        pcall(function()
            local data = {Platform = mode}
            writefile(ConfigFile, HttpService:JSONEncode(data))
        end)
    end
end

local function GetSavedPlatform()
    if isfile and isfile(ConfigFile) then
        local success, result = pcall(function()
            return HttpService:JSONDecode(readfile(ConfigFile))
        end)
        if success and result and result.Platform then
            return result.Platform
        end
    end
    return nil
end

local function ResetConfig()
    if delfile and isfile(ConfigFile) then
        delfile(ConfigFile)
    end
end

--// Theme & Sizing
Library.Theme = {
    Main = Color3.fromRGB(25, 25, 30),
    Sidebar = Color3.fromRGB(32, 32, 38),
    Content = Color3.fromRGB(25, 25, 30),
    Outline = Color3.fromRGB(50, 50, 55),
    Accent = Color3.fromRGB(0, 140, 255),
    Text = Color3.fromRGB(240, 240, 240),
    TextDark = Color3.fromRGB(160, 160, 160)
}

--// Utils
local function GetScreenSize()
    return Camera.ViewportSize
end

local function CreateShadow(parent)
    local shadow = Instance.new("ImageLabel")
    shadow.Name = "Shadow"
    shadow.Parent = parent
    shadow.BackgroundTransparency = 1
    shadow.Position = UDim2.new(0, -15, 0, -15)
    shadow.Size = UDim2.new(1, 30, 1, 30)
    shadow.Image = "rbxassetid://6015897843" -- Smooth shadow texture
    shadow.ImageColor3 = Color3.new(0,0,0)
    shadow.ImageTransparency = 0.5
    shadow.ScaleType = Enum.ScaleType.Slice
    shadow.SliceCenter = Rect.new(49, 49, 450, 450)
    shadow.ZIndex = 0
end

local function MakeDraggable(dragObj, parentObj)
    local dragging, dragInput, dragStart, startPos

    dragObj.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = parentObj.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    dragObj.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            TweenService:Create(parentObj, TweenInfo.new(0.1), {
                Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            }):Play()
        end
    end)
end

--// Main Library Logic
function Library:Window(options)
    local Title = options.Title or "UI Library"
    
    -- Detect or Ask Platform
    local Platform = GetSavedPlatform()
    
    -- Setup ScreenGui
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "VantaUI_" .. math.random(1,1000)
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    if RunService:IsStudio() then
        ScreenGui.Parent = Players.LocalPlayer:WaitForChild("PlayerGui")
    else
        ScreenGui.Parent = CoreGui
    end

    -- // PLATFORM SELECTION MODAL //
    if not Platform then
        local ModalBackdrop = Instance.new("Frame")
        ModalBackdrop.Parent = ScreenGui
        ModalBackdrop.BackgroundColor3 = Color3.fromRGB(0,0,0)
        ModalBackdrop.BackgroundTransparency = 1 -- Animate to 0.4
        ModalBackdrop.Size = UDim2.new(1, 0, 1, 0)
        ModalBackdrop.ZIndex = 100

        local ModalFrame = Instance.new("Frame")
        ModalFrame.Parent = ModalBackdrop
        ModalFrame.BackgroundColor3 = Library.Theme.Main
        ModalFrame.Size = UDim2.new(0, 0, 0, 0) -- Animate to 400, 250
        ModalFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
        ModalFrame.AnchorPoint = Vector2.new(0.5, 0.5)
        ModalFrame.ClipsDescendants = true
        
        local MCorner = Instance.new("UICorner")
        MCorner.CornerRadius = UDim.new(0, 10)
        MCorner.Parent = ModalFrame

        local Question = Instance.new("TextLabel")
        Question.Parent = ModalFrame
        Question.Text = "Select Your Platform"
        Question.Font = Enum.Font.GothamBold
        Question.TextSize = 24
        Question.TextColor3 = Library.Theme.Text
        Question.Size = UDim2.new(1, 0, 0, 60)
        Question.BackgroundTransparency = 1
        
        local function CreateChoiceBtn(text, icon, xOffset)
            local Btn = Instance.new("TextButton")
            Btn.Parent = ModalFrame
            Btn.BackgroundColor3 = Library.Theme.Sidebar
            Btn.Size = UDim2.new(0, 120, 0, 120)
            Btn.Position = UDim2.new(0.5, xOffset, 0.5, 10)
            Btn.AnchorPoint = Vector2.new(0.5, 0.5)
            Btn.Text = ""
            Btn.AutoButtonColor = false
            
            local BCorner = Instance.new("UICorner")
            BCorner.CornerRadius = UDim.new(0, 10)
            BCorner.Parent = Btn
            
            local IconImg = Instance.new("ImageLabel")
            IconImg.Parent = Btn
            IconImg.BackgroundTransparency = 1
            IconImg.Image = icon
            IconImg.Size = UDim2.new(0, 50, 0, 50)
            IconImg.Position = UDim2.new(0.5, -25, 0.5, -30)
            IconImg.ImageColor3 = Library.Theme.Accent
            
            local Lbl = Instance.new("TextLabel")
            Lbl.Parent = Btn
            Lbl.BackgroundTransparency = 1
            Lbl.Text = text
            Lbl.TextColor3 = Library.Theme.Text
            Lbl.Font = Enum.Font.GothamBold
            Lbl.TextSize = 16
            Lbl.Position = UDim2.new(0, 0, 0.8, -10)
            Lbl.Size = UDim2.new(1, 0, 0, 20)
            
            Btn.MouseButton1Click:Connect(function()
                Platform = text
                SavePlatform(text)
                -- Animate Out
                TweenService:Create(ModalBackdrop, TweenInfo.new(0.5), {BackgroundTransparency = 1}):Play()
                TweenService:Create(ModalFrame, TweenInfo.new(0.3), {Size = UDim2.new(0,0,0,0)}):Play()
                wait(0.3)
                ModalBackdrop:Destroy()
            end)
            
            -- Hover Effect
            Btn.MouseEnter:Connect(function()
                TweenService:Create(Btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(45,45,50)}):Play()
            end)
            Btn.MouseLeave:Connect(function()
                TweenService:Create(Btn, TweenInfo.new(0.2), {BackgroundColor3 = Library.Theme.Sidebar}):Play()
            end)
        end
        
        CreateChoiceBtn("Desktop", "rbxassetid://6031097225", -70)
        CreateChoiceBtn("Mobile", "rbxassetid://6031090623", 70)

        -- Animate In
        TweenService:Create(ModalBackdrop, TweenInfo.new(0.5), {BackgroundTransparency = 0.4}):Play()
        TweenService:Create(ModalFrame, TweenInfo.new(0.5, Enum.EasingStyle.Back), {Size = UDim2.new(0, 320, 0, 240)}):Play()
        
        -- Yield until chosen
        repeat wait() until Platform ~= nil
    end

    -- // APPLY SIZING BASED ON PLATFORM //
    local IsMobile = (Platform == "Mobile")
    
    local WindowSize = IsMobile and UDim2.new(0, 460, 0, 280) or UDim2.new(0, 580, 0, 380)
    local SidebarWidth = IsMobile and UDim2.new(0, 110, 1, 0) or UDim2.new(0, 150, 1, 0)
    local ButtonHeight = IsMobile and 38 or 42
    local TextSizeMain = IsMobile and 14 or 15

    -- // MAIN UI CREATION //
    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "Main"
    MainFrame.Parent = ScreenGui
    MainFrame.BackgroundColor3 = Library.Theme.Main
    MainFrame.Size = UDim2.new(0, 0, 0, 0) -- Start small for animation
    MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    MainFrame.BorderSizePixel = 0
    MainFrame.ClipsDescendants = false
    
    local MainCorner = Instance.new("UICorner")
    MainCorner.CornerRadius = UDim.new(0, 8)
    MainCorner.Parent = MainFrame
    
    CreateShadow(MainFrame)
    
    local MainStroke = Instance.new("UIStroke")
    MainStroke.Parent = MainFrame
    MainStroke.Color = Library.Theme.Outline
    MainStroke.Thickness = 1.5

    -- Sidebar
    local Sidebar = Instance.new("Frame")
    Sidebar.Parent = MainFrame
    Sidebar.BackgroundColor3 = Library.Theme.Sidebar
    Sidebar.Size = SidebarWidth
    Sidebar.BorderSizePixel = 0
    
    local SideCorner = Instance.new("UICorner")
    SideCorner.CornerRadius = UDim.new(0, 8)
    SideCorner.Parent = Sidebar

    local TitleLbl = Instance.new("TextLabel")
    TitleLbl.Parent = Sidebar
    TitleLbl.BackgroundTransparency = 1
    TitleLbl.Position = UDim2.new(0, 15, 0, 20)
    TitleLbl.Size = UDim2.new(1, -20, 0, 30)
    TitleLbl.Text = Title
    TitleLbl.Font = Enum.Font.GothamBold
    TitleLbl.TextColor3 = Library.Theme.Text
    TitleLbl.TextSize = IsMobile and 16 or 20
    TitleLbl.TextXAlignment = Enum.TextXAlignment.Left
    
    local TabHolder = Instance.new("ScrollingFrame")
    TabHolder.Parent = Sidebar
    TabHolder.BackgroundTransparency = 1
    TabHolder.Position = UDim2.new(0, 0, 0, 70)
    TabHolder.Size = UDim2.new(1, 0, 1, -80)
    TabHolder.ScrollBarThickness = 0
    
    local TabList = Instance.new("UIListLayout")
    TabList.Parent = TabHolder
    TabList.SortOrder = Enum.SortOrder.LayoutOrder
    TabList.Padding = UDim.new(0, 8)

    -- Container
    local Container = Instance.new("Frame")
    Container.Parent = MainFrame
    Container.BackgroundTransparency = 1
    Container.Position = UDim2.new(0, SidebarWidth.X.Offset + 10, 0, 10)
    Container.Size = UDim2.new(1, -(SidebarWidth.X.Offset + 20), 1, -20)
    Container.ClipsDescendants = true
    
    -- Animate Window Open
    TweenService:Create(MainFrame, TweenInfo.new(0.6, Enum.EasingStyle.Elastic), {Size = WindowSize}):Play()
    
    MakeDraggable(Sidebar, MainFrame)

    local Tabs = {}
    local First = true
    
    function Tabs:Tab(name)
        local TabBtn = Instance.new("TextButton")
        TabBtn.Parent = TabHolder
        TabBtn.BackgroundTransparency = 1
        TabBtn.Size = UDim2.new(1, 0, 0, 35)
        TabBtn.Text = name
        TabBtn.Font = Enum.Font.GothamMedium
        TabBtn.TextColor3 = Library.Theme.TextDark
        TabBtn.TextSize = TextSizeMain
        TabBtn.ZIndex = 2
        
        local Indicator = Instance.new("Frame")
        Indicator.Parent = TabBtn
        Indicator.BackgroundColor3 = Library.Theme.Accent
        Indicator.Size = UDim2.new(0, 3, 0, 20)
        Indicator.Position = UDim2.new(0, 0, 0.5, -10)
        Indicator.BackgroundTransparency = 1
        
        local Page = Instance.new("ScrollingFrame")
        Page.Parent = Container
        Page.BackgroundTransparency = 1
        Page.Size = UDim2.new(1, 0, 1, 0)
        Page.ScrollBarThickness = 3
        Page.ScrollBarImageColor3 = Library.Theme.Accent
        Page.Visible = false
        
        local PageList = Instance.new("UIListLayout")
        PageList.Parent = Page
        PageList.SortOrder = Enum.SortOrder.LayoutOrder
        PageList.Padding = UDim.new(0, 6)
        
        -- Activate Function
        local function Activate()
            for _,v in pairs(Container:GetChildren()) do
                if v:IsA("ScrollingFrame") then v.Visible = false end
            end
            for _,v in pairs(TabHolder:GetChildren()) do
                if v:IsA("TextButton") then
                    TweenService:Create(v, TweenInfo.new(0.3), {TextColor3 = Library.Theme.TextDark}):Play()
                    TweenService:Create(v.Frame, TweenInfo.new(0.3), {BackgroundTransparency = 1}):Play()
                end
            end
            
            Page.Visible = true
            TweenService:Create(TabBtn, TweenInfo.new(0.3), {TextColor3 = Library.Theme.Text}):Play()
            TweenService:Create(Indicator, TweenInfo.new(0.3), {BackgroundTransparency = 0}):Play()
        end
        
        TabBtn.MouseButton1Click:Connect(Activate)
        
        if First then
            First = false
            Activate()
        end
        
        local Elements = {}
        
        function Elements:Label(text)
            local Lab = Instance.new("TextLabel")
            Lab.Parent = Page
            Lab.BackgroundTransparency = 1
            Lab.Size = UDim2.new(1, 0, 0, 30)
            Lab.Text = text
            Lab.Font = Enum.Font.GothamBold
            Lab.TextColor3 = Library.Theme.Text
            Lab.TextSize = TextSizeMain
            Lab.TextXAlignment = Enum.TextXAlignment.Left
        end

        function Elements:Button(text, cb)
            local Btn = Instance.new("TextButton")
            Btn.Parent = Page
            Btn.BackgroundColor3 = Library.Theme.Content
            Btn.Size = UDim2.new(1, -5, 0, ButtonHeight)
            Btn.Text = text
            Btn.Font = Enum.Font.Gotham
            Btn.TextColor3 = Library.Theme.Text
            Btn.TextSize = TextSizeMain
            Btn.AutoButtonColor = false
            
            local UIC = Instance.new("UICorner")
            UIC.CornerRadius = UDim.new(0, 6)
            UIC.Parent = Btn
            
            Btn.MouseButton1Click:Connect(function()
                local rip = Instance.new("Frame")
                rip.Parent = Btn
                rip.BackgroundColor3 = Color3.new(1,1,1)
                rip.BackgroundTransparency = 0.6
                rip.AnchorPoint = Vector2.new(0.5,0.5)
                rip.Position = UDim2.new(0.5,0,0.5,0)
                rip.Size = UDim2.new(0,0,0,0)
                local corner = Instance.new("UICorner")
                corner.CornerRadius = UDim.new(1,0)
                corner.Parent = rip
                
                TweenService:Create(rip, TweenInfo.new(0.4), {Size = UDim2.new(1.5,0,1.5,0), BackgroundTransparency = 1}):Play()
                game.Debris:AddItem(rip, 0.4)
                
                if cb then cb() end
            end)
        end
        
        function Elements:Toggle(text, default, cb)
            local toggled = default or false
            local Tframe = Instance.new("TextButton")
            Tframe.Parent = Page
            Tframe.BackgroundColor3 = Library.Theme.Content
            Tframe.Size = UDim2.new(1, -5, 0, ButtonHeight)
            Tframe.Text = ""
            Tframe.AutoButtonColor = false
            
            local UIC = Instance.new("UICorner")
            UIC.CornerRadius = UDim.new(0, 6)
            UIC.Parent = Tframe
            
            local Txt = Instance.new("TextLabel")
            Txt.Parent = Tframe
            Txt.BackgroundTransparency = 1
            Txt.Position = UDim2.new(0, 10, 0, 0)
            Txt.Size = UDim2.new(1, -60, 1, 0)
            Txt.Text = text
            Txt.Font = Enum.Font.Gotham
            Txt.TextColor3 = Library.Theme.Text
            Txt.TextSize = TextSizeMain
            Txt.TextXAlignment = Enum.TextXAlignment.Left
            
            local Switch = Instance.new("Frame")
            Switch.Parent = Tframe
            Switch.BackgroundColor3 = toggled and Library.Theme.Accent or Color3.fromRGB(60,60,60)
            Switch.Position = UDim2.new(1, -50, 0.5, -10)
            Switch.Size = UDim2.new(0, 40, 0, 20)
            
            local SWC = Instance.new("UICorner")
            SWC.CornerRadius = UDim.new(1,0)
            SWC.Parent = Switch
            
            local Dot = Instance.new("Frame")
            Dot.Parent = Switch
            Dot.BackgroundColor3 = Color3.new(1,1,1)
            Dot.Size = UDim2.new(0, 16, 0, 16)
            Dot.Position = toggled and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
            
            local DC = Instance.new("UICorner")
            DC.CornerRadius = UDim.new(1,0)
            DC.Parent = Dot
            
            Tframe.MouseButton1Click:Connect(function()
                toggled = not toggled
                local pos = toggled and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
                local col = toggled and Library.Theme.Accent or Color3.fromRGB(60,60,60)
                
                TweenService:Create(Dot, TweenInfo.new(0.2), {Position = pos}):Play()
                TweenService:Create(Switch, TweenInfo.new(0.2), {BackgroundColor3 = col}):Play()
                if cb then cb(toggled) end
            end)
        end
        
        function Elements:Slider(text, min, max, default, cb)
            local value = default or min
            local SliderFrame = Instance.new("Frame")
            SliderFrame.Parent = Page
            SliderFrame.BackgroundColor3 = Library.Theme.Content
            SliderFrame.Size = UDim2.new(1, -5, 0, ButtonHeight + 15)
            
            local UIC = Instance.new("UICorner")
            UIC.CornerRadius = UDim.new(0, 6)
            UIC.Parent = SliderFrame
            
            local Txt = Instance.new("TextLabel")
            Txt.Parent = SliderFrame
            Txt.BackgroundTransparency = 1
            Txt.Position = UDim2.new(0, 10, 0, 5)
            Txt.Size = UDim2.new(1, -20, 0, 20)
            Txt.Text = text
            Txt.Font = Enum.Font.Gotham
            Txt.TextColor3 = Library.Theme.Text
            Txt.TextSize = TextSizeMain
            Txt.TextXAlignment = Enum.TextXAlignment.Left
            
            local ValTxt = Instance.new("TextLabel")
            ValTxt.Parent = SliderFrame
            ValTxt.BackgroundTransparency = 1
            ValTxt.Position = UDim2.new(1, -60, 0, 5)
            ValTxt.Size = UDim2.new(0, 50, 0, 20)
            ValTxt.Text = tostring(value)
            ValTxt.Font = Enum.Font.Gotham
            ValTxt.TextColor3 = Library.Theme.TextDark
            ValTxt.TextSize = TextSizeMain
            
            local Bar = Instance.new("TextButton")
            Bar.Parent = SliderFrame
            Bar.BackgroundColor3 = Color3.fromRGB(40,40,40)
            Bar.Position = UDim2.new(0, 10, 0, 35)
            Bar.Size = UDim2.new(1, -20, 0, 6)
            Bar.Text = ""
            Bar.AutoButtonColor = false
            
            local BC = Instance.new("UICorner")
            BC.CornerRadius = UDim.new(1,0)
            BC.Parent = Bar
            
            local Fill = Instance.new("Frame")
            Fill.Parent = Bar
            Fill.BackgroundColor3 = Library.Theme.Accent
            Fill.Size = UDim2.new((value - min)/(max - min), 0, 1, 0)
            
            local FC = Instance.new("UICorner")
            FC.CornerRadius = UDim.new(1,0)
            FC.Parent = Fill
            
            local dragging = false
            
            local function update(input)
                local SizeX = math.clamp((input.Position.X - Bar.AbsolutePosition.X) / Bar.AbsoluteSize.X, 0, 1)
                local NewValue = math.floor(min + ((max - min) * SizeX))
                
                TweenService:Create(Fill, TweenInfo.new(0.05), {Size = UDim2.new(SizeX, 0, 1, 0)}):Play()
                ValTxt.Text = tostring(NewValue)
                if cb then cb(NewValue) end
            end
            
            Bar.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    dragging = true
                    update(input)
                end
            end)
            
            UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    dragging = false
                end
            end)
            
            UserInputService.InputChanged:Connect(function(input)
                if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                    update(input)
                end
            end)
        end
        
        return Elements
    end
    
    function Library:Notify(text)
        local Notif = Instance.new("TextLabel")
        Notif.Parent = ScreenGui
        Notif.BackgroundColor3 = Library.Theme.Main
        Notif.Size = UDim2.new(0, 200, 0, 50)
        Notif.Position = UDim2.new(0.5, -100, 1, 50)
        Notif.Text = text
        Notif.Font = Enum.Font.GothamBold
        Notif.TextColor3 = Library.Theme.Text
        Notif.TextSize = 14
        
        local NC = Instance.new("UICorner")
        NC.CornerRadius = UDim.new(0, 8)
        NC.Parent = Notif
        
        TweenService:Create(Notif, TweenInfo.new(0.5), {Position = UDim2.new(0.5, -100, 1, -100)}):Play()
        wait(2)
        TweenService:Create(Notif, TweenInfo.new(0.5), {Position = UDim2.new(0.5, -100, 1, 50)}):Play()
        wait(0.5)
        Notif:Destroy()
    end
    
    function Library:DestroyConfig()
        ResetConfig()
        ScreenGui:Destroy()
    end
    
    return Tabs
end

return Library
